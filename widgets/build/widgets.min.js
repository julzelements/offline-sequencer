function getSixteenths(e){return parseFloat(e.split(":")[2])}function getBeats(e){return parseFloat(e.split(":")[1])}function getBars(e){return parseFloat(e.split(":")[0])}function getTotalBeats(e){return 4*getBars(e)+getBeats(e)+getSixteenths(e)/4}function beatsAsBarsBeatsSixteenths(e){return Tone.Time("0:1:0 * "+e).toBarsBeatsSixteenths()}function canPlayAudio(e){return Tone.Buffer.supportsType(e)}function getAudioExtension(){var e=".wav";return canPlayAudio("ogg")?e=".ogg":canPlayAudio("mp4")&&(e=".mp4"),e}function pathToWidgetSounds(){return"/lessons/sounds/"}function pctInRange(e,t,n){return(n-e)/(t-e)}function fitsInRange(e,t,n){return n>=e&&n<=t}function almostEqual(e,t,n){return null==n&&(n=.001),Math.abs(e-t)<n}function nearest(e,t){for(var n=Number.MAX_VALUE,o=0;o<t.length;o++){var i=t[o],r=Math.abs(e-n);Math.abs(e-i)<=r&&(n=i)}return n}function assert(e,t){if(!e){if(t=t||"Assertion failed","undefined"!=typeof Error)throw new Error(t);throw t}}function storageAvailable(e){try{var t=window[e],n="__storage_test__";return t.setItem(n,n),t.removeItem(n),!0}catch(e){return!1}}function getSavedModelString(e){return storageAvailable("localStorage")?localStorage.getItem(e):void 0}function getSavedModel(e){try{return JSON.parse(getSavedModelString(e))}catch(e){return}}function tryRestoreApp(e,t,n){var o=getSavedModel(e);if(o&&o.version==n)return t.ports.importModel.send(o),o}function trySaveState(e,t,n){if(storageAvailable("localStorage"))try{var o=e;o.version=n;var i=JSON.stringify(o);localStorage.setItem(t,i),isDeveloperMode()&&console.log(i)}catch(e){return}}function isDeveloperMode(){return window.location.href.includes("localhost")||DEVELOPER_MODE}function isMobile(){return!!(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i))}function isChromeOnIOS(){return!!navigator.userAgent.match("CriOS")}function keyFromPhysicalCode(e){return e.includes("Digit")?e.split("Digit")[1]:e.includes("Key")?e.split("Key")[1]:void 0}function keyEventToPhysicalKey(e){return e.code?keyFromPhysicalCode(e.code):String.fromCharCode(e.keyCode)}function ToneTransportStartDelay(){return"+0.1"}function onYouTubeIframeAPIReady(){YOUTUBEWIDGETS.forEach(function(e){e.onYouTubeIframeAPIReady()}),YOUTUBE_API_READY=!0}var AudioSupervisor=this.AudioSupervisor=function(){function e(){document.addEventListener&&document.addEventListener("visibilitychange",t)}function t(){document.hidden&&Tone?Tone.Master.volume.rampTo(-1/0,.3):Tone&&Tone.Master.volume.rampTo(0,.4)}function n(e){function t(){Tone.context.resume().then(function(){e.removeEventListener("touchstart",t,!0),e.removeEventListener("touchend",t,!0),e.removeEventListener("mousedown",t,!0),e.removeEventListener("mouseup",t,!0),e.removeEventListener("click",t,!0)})}e.addEventListener("touchstart",t,!0),e.addEventListener("touchend",t,!0),e.addEventListener("mousedown",t,!0),e.addEventListener("mouseup",t,!0),e.addEventListener("click",t,!0)}function o(e){-1==u.indexOf(e)&&u.push(e)}function i(e){u=u.filter(function(t){return t!=e})}function r(e){return 1===u.length&&u[0]===e}function a(){return u.length>0}function s(){return Tone.Master}function l(t){e(),Tone.Transport.latencyHint=isMobile()?.06:"fastest",u=[]}var d=this;d.init=l,d.makeGestureOnElementResumeAudioContext=n,d.registerPlayingWidget=o,d.unregisterPlayingWidget=i,d.isOnlyWidgetPlaying=r,d.areAnyWidgetsPlaying=a,d.masterEffectChain=s;var u;return d},BrowserCompatibility={isBrowserCompatible:function(){var e=window.hasOwnProperty("AudioContext")||window.hasOwnProperty("webkitAudioContext"),t=window.hasOwnProperty("Promise"),n=window.hasOwnProperty("Worker");return e&&t&&n},appendCompatibilityWarning:function(e,t){var n=document.createElement("div");n.className="widget__compatibility-message",n.innerHTML=t,e.appendChild(n)}},Drumkit=this.Drumkit=function(){function e(e){return a||(a=new Promise(function(n){var o=e.map(function(e){return{path:e.path,name:e.midi+""}}),i=SAMPLE_CACHE.getBuffers(o);l=new Tone.MultiPlayer(i).toMaster(),l.fadeOut=.01,s=n,Tone.Buffer.on("progress",t),Tone.Buffer.on("load",t),t()}))}function t(){l.buffers.loaded&&s()}function n(e,t,n){l.start(e+"",t),n&&Workarounds.multiplayerStopAll(l,n+"",t)}function o(e){e.forEach(function(t){e.some(function(e){return t.lane.midi===e.lane.choke})||n(t.lane.midi,t.time,t.lane.choke)})}function i(){l.stopAll()}var r=this;r.init=e,r.playNoteAtNumber=n,r.playNotes=o,r.stopAll=i;var a,s,l;return r},KeySupervisor=this.KeySupervisor=function(){function e(e){return!0===s[e.keyCode]}function t(e,t,n){u&&u(),l=e,d=t,u=n}function n(){window.addEventListener("keydown",function(t){e(t)||(s[t.keyCode]=!0,l&&l(t))}),window.addEventListener("keyup",function(e){s[e.keyCode]=!1,d&&d(e)})}function o(){document.addEventListener&&document.addEventListener("visibilitychange",i)}function i(){document.hidden&&u&&(u(),l=null,d=null,u=null)}function r(e){n(),o(),s={}}var a=this;a.init=r,a.connectWidget=t;var s,l,d,u;return a},LiveSetExport={serviceURL:"https://learningmusic-export.ableton.com",checkExportServiceAvailablility:function(e){function t(){e(!0)}function n(){e(!1)}function o(){e(!1)}function i(){e(!1)}var r=new XMLHttpRequest;r.timeout=5e3,r.addEventListener("load",t),r.addEventListener("error",n),r.addEventListener("abort",o),r.addEventListener("timeout",i),r.open("GET",LiveSetExport.serviceURL+"/availability"),r.send()},createLiveSet:function(e,t,n){function o(){n(void 0);var e=this.responseText;if(LiveSetExport.userHasAlreadyExportedOnce())LiveSetExport.isValidFileId(e)&&(window.location=LiveSetExport.downloadURLFromFileId(e));else{storageAvailable("localStorage")&&localStorage.setItem("__userHasExported","yes");var t="?fileId="+e;d.location.href=LOCALE_PATH+"/live-set-export.html"+t}}function i(){n("Export failed.")}function r(){n("Export was cancelled.")}var a=new Date,s=a.toDateString().replace(/[^a-z0-9]/gi,"_"),l={backlink:window.location.href,name:"idea_"+s,tempo:e,tracks:t};if(!LiveSetExport.userHasAlreadyExportedOnce())var d=window.open(LOCALE_PATH+"/live-set-export-waiting.html","_blank");var u=new XMLHttpRequest;u.addEventListener("load",o),u.addEventListener("error",i),u.addEventListener("abort",r),u.open("POST",LiveSetExport.serviceURL+"/export"),u.setRequestHeader("Content-Type","application/json;charset=UTF-8"),u.send(JSON.stringify(l))},downloadURLFromFileId:function(e){return LiveSetExport.serviceURL+"/export?id="+e},userHasAlreadyExportedOnce:function(){return!!storageAvailable("localStorage")&&"yes"==localStorage.getItem("__userHasExported")},isValidFileId:function(e){return e.match("[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}")},createDownloadLink:function(e,t){var n=function(e){var t=window.location.href,n=new RegExp("[?&]"+e+"=([^&#]*)","i"),o=n.exec(t);return o?o[1]:null}("fileId");if(LiveSetExport.isValidFileId(n)){void 0===t&&(t="");var o=document.createElement("a"),i=document.createTextNode("Download");o.appendChild(i),o.title="Download your music as an Ableton Live Set",o.href=LiveSetExport.downloadURLFromFileId(n),o.className=t,document.getElementById(e).appendChild(o),o.addEventListener("click",function(){o.style.display="none"})}else document.getElementById(e).innerHTML="Error exporting to Live. Please try again."}},LiveSetExporter=this.LiveSetExporter=function(){function e(e){o.push(e),e.bind("export",function(e,t){var n=e.getExportInfo();if("takeover"===e.getConfig().onPlay)LiveSetExport.createLiveSet(n.tempo,n.tracks,t);else{var i=o.reduce(function(e,t){return e.concat(t.getExportInfo().tracks)},[]);LiveSetExport.createLiveSet(n.tempo,i,t)}})}function t(){o=[]}var n=this;n.init=t,n.registerWidget=e;var o;return n},Loader=this.Loader=function(){function e(){i.style.display="none"}function t(){o.style.display="none"}function n(e){o=document.createElement("div"),o.id=e.widgetId+"loader",o.className="",i=document.createElement("div"),i.className="widget-loader__loading-animation",o.appendChild(i),document.getElementById(e.widgetId).appendChild(o)}var o,i,r=this;return r.init=n,r.hide=t,r.onAudioLoaded=e,r},Metronome=this.Metronome=function(){function e(){a=new Tone.Sequence(function(e,t){r.start(t,e)},["metroup","metro","metro","metro"],"4n")}function t(t){e(),a.start(t)}function n(e){a.stop(e),a.dispose()}function o(t){var n=pathToWidgetSounds(),o={metro:n+"metronome/Metronome"+getAudioExtension(),metroup:n+"metronome/MetronomeUp"+getAudioExtension()};r=new Tone.MultiPlayer(o,e).toMaster(),r.volume.value=12}var i=this;i.init=o,i.start=t,i.stop=n;var r,a;return i},Piano=this.Piano=function(){function e(e){return u=e,s||(s=new Promise(function(n){var o=e.samples.map(function(e){return{path:e.path,name:e.midi+""}}),i=SAMPLE_CACHE.getBuffers(o);d=new Tone.MultiPlayer(i),d.connect(SUPERVISOR.masterEffectChain()),d.fadeOut=e.fadeout.duration,c=[];for(var a=0;a<128;a++)c.push(r(a,e.samples));l=n,Tone.Buffer.on("progress",t),Tone.Buffer.on("load",t),t()})),s}function t(){d.buffers.loaded&&l()}function n(e,t,n){o(Math.round(Tone.Frequency(e).toMidi()),t,n)}function o(e,t,n){var o=c[e];d.start(o.val+"",t,0,n+"-"+u.fadeout.offset,o.offset)}function i(){d.stopAll()}function r(e,t){var n=t.map(function(e){return e.midi}),o=nearest(e,n);return{val:o,offset:e-o}}var a=this;a.init=e,a.playNoteAtFrequency=n,a.playNoteAtNumber=o,a.stopAll=i;var s,l,d,u,c;return a},Recorder=this.Recorder=function(){function e(e){o&&o(e)}function t(e){o=e}function n(e){}var o,i=this;return i.init=n,i.recordEvent=e,i.connect=t,i},SampleCache=this.SampleCache=function(){function e(e,t){if(i.has(e))return i.get(e);var n=t||getAudioExtension(),o=pathToWidgetSounds()+e+n;return i.add(e,o),i.get(e)}function t(e){var t=new Tone.Buffers;return e.forEach(function(e){t.add(e.name,o.getBuffer(e.path,e.extension))}),t}function n(){i=new Tone.Buffers}var o=this;o.init=n,o.getBuffer=e,o.getBuffers=t;var i;return o},SingleTouchObserver=this.SingleTouchObserver=function(){function e(e){o=e,d3.select(e.node).append("div").attr("class","mouseObserver").style("width","100%").style("height","100%").on("mousedown",t).on("touchstart",t)}function t(){function e(){var e=d3.mouse(n.node());o.onMove(e[0],e[1])}function t(){var e=d3.mouse(n.node());i.on("touchmove",null).on("mousemove",null).on("mouseup",null).on("touchend",null),o.onUp(e[0],e[1])}if(isMobile()||0===d3.event.button){var n=d3.select(this).classed("active",!0),i=d3.select(window).on("touchmove",e).on("mousemove",e).on("mouseup",t).on("touchend",t),r=d3.mouse(this);o.onDown(r[0],r[1]),document.activeElement&&document.activeElement.blur(),d3.event.preventDefault()}}var n=this;n.init=e;var o;return n},Tooltip={inject:function(e,t,n,o,i){if(t&&e){if(!(Tooltip.userHasSeenTooltip(t.name)&&!t.showalways)){e.getBoundingClientRect();xShiftFactor=0,"left"==i?xShiftFactor=.25:"right"==i&&(xShiftFactor=-.25),xShiftInPx=200*xShiftFactor;var r=document.createElement("div");r.className="widget-tooltip",r.style.width="200px",r.style.top=n||"100%",r.style.left=o||"50%",r.style.marginTop="12px",r.style.marginLeft=-100+xShiftInPx+"px";var a=document.createElement("div");a.className="widget-tooltip__triangle",a.style.top="-20px",a.style.left=90-xShiftInPx+"px",a.style.border="solid 10px",a.style.borderColor="transparent transparent black transparent",r.appendChild(a);var s=document.createElement("div");s.className="widget-tooltip__text",s.innerHTML=t["@text"],r.appendChild(s);var l=document.createElement("div");l.className="widget-tooltip__dismiss",l.innerHTML=t["@close"]?t["@close"]:"Close",r.appendChild(l),r.addEventListener("click",function(){r.classList.add("widget-tooltip--hide"),Tooltip.setUserHasSeenTooltip(t.name)}),e.appendChild(r)}}},tooltipKeyForLocalStorage:function(e){return"__tooltip_"+e},userHasSeenTooltip:function(e){return!!storageAvailable("localStorage")&&"dismissed"==localStorage.getItem(Tooltip.tooltipKeyForLocalStorage(e))},setUserHasSeenTooltip:function(e){storageAvailable("localStorage")&&localStorage.setItem(Tooltip.tooltipKeyForLocalStorage(e),"dismissed")},appendTooltippableChild:function(e,t){var n=document.createElement("div");n.style.position="relative",n.appendChild(t),e.appendChild(n)}},Transport=this.Transport=function(){function e(){return w}function t(){return E}function n(){return S}function o(){return"playing"==b}function i(){return I}function r(e){I=e,("join"==T.onPlay||"takeover"==T.onPlay&&"playing"==b)&&(Tone.Transport.bpm.value=I,Tone.Transport.emit("sessionTempoChanged",I)),T.onTempoChanged&&T.onTempoChanged(I)}function a(e){"join"==T.onPlay&&(I=e,T.onTempoChanged&&T.onTempoChanged(I))}function s(){var e={playing:"<i class='icon-pause'></i>",queued:"<i class='icon-play widget_transport-icon--queued'></i>",stopped:"<i class='icon-play'></i>"};w.innerHTML=e[b],w.className="btn widget__transport-btn"}function l(){E.innerHTML="<i class='icon-record'></i>";var e=T.showRecordButton?"":" hidden";E.className=S&&"playing"==b?"btn widget__transport-btn widget-button--recording"+e:"btn widget__transport-btn"+e}function d(){s(),l()}function u(){S&&(S=!1,METRONOME.stop()),T.onStopPlayback(),SUPERVISOR.unregisterPlayingWidget(T.widgetId),b="stopped",d()}function c(e){"playing"==b&&u()}function p(){Tone.Transport.bpm.value=I,Tone.Transport.position="0:0:0",Tone.Transport.start(ToneTransportStartDelay()),S&&METRONOME.start(),T.onStartPlayback(),SUPERVISOR.registerPlayingWidget(T.widgetId),b="playing",d()}function f(){S&&METRONOME.start("@1m"),Tone.Transport.scheduleOnce(function(e){b="playing",d()},"@1m"),T.onStartQuantizedPlayback(),SUPERVISOR.registerPlayingWidget(T.widgetId),b="queued",d()}function m(){Tone.Transport.position="0:0:0",Tone.Transport.stop(),u()}function g(){if(P=!0,"queued"!=b)if(SUPERVISOR.areAnyWidgetsPlaying()){if(SUPERVISOR.areAnyWidgetsPlaying()){var e="playing"==b;"takeover"==T.onPlay?e?m():(Tone.Transport.emit("takeover"),m(),p()):"join"==T.onPlay&&(e?SUPERVISOR.isOnlyWidgetPlaying(T.widgetId)?m():c(0):f())}}else p()}function v(){S=!S,"playing"==b?S?METRONOME.start("0:0:0"):METRONOME.stop():g(),d()}function h(e){T=e,y=document.createElement("div"),y.className="widget-transport",e.node.appendChild(y),w=document.createElement("button"),w.onclick=g,Tooltip.appendTooltippableChild(y,w),w.parentElement.classList.add("widget__transport-btn-wrapper"),E=document.createElement("button"),E.onclick=v,Tooltip.appendTooltippableChild(y,E),E.parentElement.classList.add("widget__transport-btn-wrapper"),b="stopped",S=!1,P=!1,I=e.tempo,Tone.Transport.on("takeover",c),Tone.Transport.on("sessionTempoChanged",a),d()}var y,T,w,E,b,S,I,P,x=this;return x.init=h,x.isRecording=n,x.isPlaying=o,x.getTempo=i,x.setTempo=r,x.playButton=e,x.recordButton=t,x},DEVELOPER_MODE=!1,Workarounds={multiplayerStopAll:function(e,t,n){try{for(;;)e.stop(t,n)}catch(e){}}},PitchpadSynth=this.PitchpadSynth=function(){function e(){return u.findIndex(function(e){return null===e})}function t(e){return u.findIndex(function(t){return t===e})}function n(e){var t=Tone.context.currentTime;f[e].gain.cancelScheduledValues(t),f[e].gain.setTargetAtTime(1,t+.02,.001),f[e].gain.setTargetAtTime(.3,t+.02+.1,.01)}function o(e){var t=Tone.context.currentTime;f[e].gain.cancelScheduledValues(t),f[e].gain.setTargetAtTime(0,t+.05,.1)}function i(t,o){var i=e();-1!=i&&(u[i]=t,p[i].frequency.setValueAtTime(o,Tone.context.currentTime),m[i]=o,n(i))}function r(e,o,i){var r=t(e);-1!=r&&(p[r].frequency.setValueAtTime(o,Tone.context.currentTime),i&&!almostEqual(o,m[r])&&n(r),m[r]=o)}function a(e){var n=t(e);-1!=n&&(o(n),u[n]=null,m[n]=-1)}function s(){for(var e=0;e<c;e++)a(u[e])}function l(e){u=[],c=3,p=[],f=[],m=[],g=Tone.context.createGain(),g.connect(Tone.Master),g.gain.value=.5;for(var t=0;t<c;t++){u[t]=null;var n=Tone.context.createOscillator(),o=Tone.context.createGain();n.type="triangle",n.connect(o),o.connect(g),o.gain.value=1e-6,n.start(0),p.push(n),f.push(o),m.push(-1)}}var d=this;d.init=l,d.startTouch=i,d.moveTouch=r,d.stopTouch=a,d.stopAll=s;var u,c,p,f,m,g;return d},GLOBAL_PITCHPAD_SYNTH,ScaleExplorer=this.ScaleExplorer=function(){function e(e){return P.isQuantized?R(e):C(e)}function t(){return parseInt(x.style("width"),10)}function n(){return parseInt(x.style("height"),10)}function o(){function t(){d3.event.preventDefault();for(var t=0;t<d3.event.changedTouches.length;t++){var n=d3.event.changedTouches.item(t),o=d3.touch(i.node(),n.identifier)[0];L.moveTouch(n.identifier,e(o),P.isQuantized)}d(d3.touches(x.node()))}function n(){d3.event.preventDefault();for(var t=0;t<d3.event.changedTouches.length;t++){var n=d3.event.changedTouches.item(t),o=d3.touch(i.node(),n.identifier)[0];L.stopTouch(n.identifier,e(o))}d(d3.touches(x.node()))}function o(){d3.event.preventDefault();for(var t=0;t<d3.event.changedTouches.length;t++){var n=d3.event.changedTouches.item(t),o=d3.touch(i.node(),n.identifier)[0];L.stopTouch(n.identifier,e(o))}d(d3.touches(x.node()))}d3.event.preventDefault();var i=d3.select(this).classed("active",!0);i.on("touchmove",t).on("touchend",n).on("touchcancel",o);for(var r=0;r<d3.event.changedTouches.length;r++){var a=d3.event.changedTouches.item(r),s=d3.touch(i.node(),a.identifier)[0];L.startTouch(a.identifier,e(s))}d(d3.touches(x.node()))}function i(){if(k){k=!1;var e=x.selectAll("circle.widget-scale-explorer__touch").data(A);e.exit().remove(),e.enter().append("circle").attr("class","widget-scale-explorer__touch").attr("r","15px").merge(e).attr("cx",function(e){return e[0]}).attr("cy",function(e){return n()/2})}}function r(){function t(){var t=d3.mouse(o.node());d([t]),L.moveTouch("mouse",e(t[0]),P.isQuantized)}function n(){d([]),L.stopTouch("mouse"),i.on("mousemove",null).on("mouseup",null)}var o=d3.select(this).classed("active",!0),i=d3.select(window).on("mousemove",t).on("mouseup",n);L.startTouch("mouse",e(d3.mouse(this)[0])),d([d3.mouse(this)]),d3.event.preventDefault()}function a(e){var t=keyEventToPhysicalKey(e);return void 0==t?-1:P.keyboard.split("").findIndex(function(e){return e.toUpperCase()==t.toUpperCase()})}function s(e){var t=a(e);if(!(t<0)){var n=E()[t];if(L.startTouch("key"+t,n),M[t]=!0,N){var o=b()[t];N.ports.noteOn.send(o)}}}function l(e){var t=a(e);if(!(t<0)&&(L.stopTouch("key"+t),M[t]=!1,N)){var n=b()[t];N.ports.noteOff.send(n)}}function d(e){if(k=!0,A=e,O&&N){var n=E().length,o=[],i=t()/n;A.forEach(function(e){var t=e[0],r=_.clamp(Math.floor(t/i),0,n-1);o.push(r)});for(var r=0;r<O.length;r++){var a=O[r];if(void 0!=o.find(function(e){return e==r})){if(!a){O[r]=!0;var s=b()[r];N.ports.noteOn.send(s)}}else if(a){O[r]=!1;var s=b()[r];N.ports.noteOff.send(s)}}}}function u(){h(),d([])}function c(){KEY_SUPERVISOR.connectWidget(null,null,null)}function p(){N.ports.resetNoteOnState.send(!0),N.ports.keyboardDisconnected.send(!0);for(var e=0;e<M.length;e++)M[e]&&(L.stopTouch("key"+e),M[e]=!1)}function f(){KEY_SUPERVISOR.connectWidget(s,l,p)}function m(){var e=b()[0];return e-e%12}function g(){SUPERVISOR.makeGestureOnElementResumeAudioContext(document.getElementById(P.widgetId));var e=document.getElementById(P.widgetId);e.style.position="relative";var t=document.createElement("div");t.id=P.widgetId+"appHolder",t.style.textAlign="center",e.appendChild(t),N=Elm.ScaleExplorer.embed(t,{scale:b(),startNote:m(),customNoteNames:T(),customNoteColors:w(),showPiano:"yes"==P.showPiano,showPads:P.isQuantized,showScaleChooser:"yes"==P.showScaleChooser,showRootChooser:"yes"==P.showRootChooser,availableScaleNames:P.availableScales.split(","),defaultScaleName:P.defaultScale,defaultRootName:P.defaultRoot,scaleCanBeMappedToPiano:!("no"==P.scaleCanBeMappedToPiano),keyboardMappings:P.keyboard?P.keyboard.split(""):[],showKeyboardButton:P.isQuantized&&!isMobile(),lang:P.lang}),N.ports.exportScale.subscribe(function(e){B=e,h(),L.stopAll()}),N.ports.keyboardActive.subscribe(function(e){e?f():c()}),GLOBAL_PITCHPAD_SYNTH||(GLOBAL_PITCHPAD_SYNTH=new PitchpadSynth,GLOBAL_PITCHPAD_SYNTH.init()),L=GLOBAL_PITCHPAD_SYNTH,x=d3.select("#"+P.widgetId).append("svg").attr("class","widget-scale-explorer__mouse-observer grabbable").style("left","0").style("bottom","0").style("width","100%"),x.on("mousedown",r),x.on("mousemove",function(){d3.event.preventDefault()}),x.on("mouseup",function(){d3.event.preventDefault()}),x.on("touchstart",o),u(),window.addEventListener("resize",u),M=E().map(function(e){return!1}),O=E().map(function(e){return!1}),d([]),d3.timer(i),P.tip&&v(P.tip)}function v(e){switch(e){case"lowhighpitch":Tooltip.inject(document.getElementById(P.widgetId),function(e){var t=P.tips[e];return t.name=e,t["@close"]=P.lang["@close"],t}(e),"80%")}}function h(){R=d3.scaleQuantize().domain([0,t()]).range(E()),C=d3.scaleLinear().domain([0,t()]).range(E()).clamp(!0)}function y(){return P.defaultRoot||P.defaultScale}function T(){return y()?null:P.frequencies.map(function(e){return e.name})}function w(){return y()?null:P.frequencies.map(function(e){return e.color?e.color:""})}function E(){return y()?b().map(function(e){return Tone.Frequency(e,"midi").toFrequency()}):P.frequencies.map(function(e){return e.freq})}function b(){return y()?B||[0,2,4,5,7,9,11,12].map(function(e){return e+60}):"no"!=P.scaleCanBeMappedToPiano?P.frequencies.map(function(e){return Math.round(Tone.Frequency(e.freq).toMidi())}):P.frequencies.map(function(e,t){return t})}function S(e){if(!BrowserCompatibility.isBrowserCompatible())return void BrowserCompatibility.appendCompatibilityWarning(document.getElementById(e.widgetId),e.lang["@incompatiblebrowser"]);P=e,mLoader=new Loader,mLoader.init(e),mLoader.onAudioLoaded(),g()}var I=this;I.init=S;var P,x,L,C,R,A,k,M,O,B,N;return I},SimpleDrumpad=this.SimpleDrumpad=function(){function e(e){return e.name.replace(/\s/g,"")}function t(e){n(e),E.playNoteAtNumber(e.midi,0,e.choke),v.recorder&&v.recorder.recordEvent(e)}function n(t){y.select("#"+e(t)).transition().duration(50).style("background-color","#FED134").transition().duration(200).style("background-color","#858585")}function o(){var n=T.selectAll(".widget__pad").data(v.kit.samples);n.enter().append("div").attr("class","widget__pad widget__pad--drum").attr("id",function(t,n){return e(t)}).on("mousedown",function(e,n){t(e),d3.event.preventDefault()}).on("touchstart",function(e,n){d3.event.stopPropagation(),d3.event.preventDefault(),t(e)}).merge(n).html(function(e,t){return b?"<kbd class='widget__pad__key'>"+v.keyboard.split("")[t].toUpperCase()+"</kbd><div class='widget__pad__label'>"+e.name+"</div>":"<div class='widget__pad__label'>"+e.name+"</div>"})}function i(e){var t=keyEventToPhysicalKey(e);return void 0==t?-1:v.keyboard.split("").findIndex(function(e){return e.toUpperCase()==t.toUpperCase()})}function r(e){var n=i(e);-1!=n&&t(v.kit.samples[n])}function a(e){}function s(){b=!1,d(),o()}function l(){b?(KEY_SUPERVISOR.connectWidget(null,null,null),s()):(KEY_SUPERVISOR.connectWidget(r,a,s),b=!0),d(),o()}function d(){var e=b?"widget__keyboard-button--on":"widget__keyboard-button--off";S.className="btn btn--link btn--cropped widget__keyboard-button "+e}function u(){if(!isMobile()){var e=document.getElementById(v.widgetId);w=document.createElement("div"),w.className="widget-drumpad__header",w.style.justifyContent="flex-end",e.appendChild(w),S=document.createElement("button"),S.innerHTML=v.lang["@keyboard"],S.onclick=l,Tooltip.appendTooltippableChild(w,S),S.parentElement.style.width="80px",S.parentElement.classList.add("widget__keyboard-button__wrapper"),d()}}function c(){return void 0!=v.recorder}function p(){h.onAudioLoaded(),SUPERVISOR.makeGestureOnElementResumeAudioContext(document.getElementById(v.widgetId)),y=d3.select("#"+v.widgetId),c()?(T=y.append("div").attr("id","padHolder").attr("class","widget__pads"),u()):(u(),T=y.append("div").attr("id","padHolder").attr("class","widget__pads")),o(),v.tip&&f(v.tip)}function f(e){function t(e){var t=v.tips[e];return t.name=e,t["@close"]=v.lang["@close"],t}switch(e){case"keyboard":if(isMobile())return;Tooltip.inject(S.parentElement,t(e));break;case"drumpad":document.getElementById(v.widgetId).style.position="relative",Tooltip.inject(document.getElementById(v.widgetId),t(e),"95%","25%","left")}}function m(e){if(!BrowserCompatibility.isBrowserCompatible())return void BrowserCompatibility.appendCompatibilityWarning(document.getElementById(e.widgetId),e.lang["@incompatiblebrowser"]);v=e,h=new Loader,h.init(v),c()&&h.hide(),b=!1,E=new Drumkit,E.init(e.kit.samples).then(p)}var g=this;g.init=m;var v,h,y,T,w,E,b,S;return g},PianoRollAssessment={lanesMatch:function(e,t,n){var o=e.events.filter(function(e){return e.lane==n}),i=t.events.filter(function(e){return e.lane==n});return o.length==i.length&&o.every(function(e){return i.find(function(t){return e.start===t.start&&e.duration===t.duration&&e.lane===t.lane})})},populatedLanesMatch:function(e,t,n){if(!e||!t)return!1;for(var o=0;o<n;o++){if(e.events.filter(function(e){return e.lane==o}).length>0&&!PianoRollAssessment.lanesMatch(e,t,o))return!1}return!0},modelsMatch:function(e,t,n){if(!e||!t)return!1;if(e.events.length!=t.events.length)return!1;for(var o=0;o<n;o++)if(!PianoRollAssessment.lanesMatch(e,t,o))return!1;return!0}},PIANOROLL_VERSION=2,PianoRollEditor=this.PianoRollEditor=function(){function e(e){P=e,l()}function t(){I.ports.clear.send("")}function n(e){e&&e.version==PIANOROLL_VERSION&&(e.lanes=P.lanes,e.showSettings=!0,void 0!=e.scaleName&&"yes"==P.showScaleChooser||(e.scaleName=P.defaultScale?P.defaultScale:null),void 0!=e.rootName&&"yes"==P.showRootChooser||(e.rootName=P.defaultRoot?P.defaultRoot:null),e.octave=P.defaultOctave?parseInt(P.defaultOctave):null,e.octaveCount=P.defaultOctaveCount?parseInt(P.defaultOctaveCount):null,void 0==e.tempo?e.tempo=parseFloat(P.tempo):e.tempo=parseFloat(e.tempo),I.ports.importModel.send(e))}function o(e){I.ports.setTempo.send(parseFloat(e))}function i(e){I.ports.setOptions.send(e)}function r(e){return x}function a(){return R.parentElement}function s(e){I.ports.record.send([e.lane,e.start])}function l(){for(var e=P.lanes,t=0;t<e.length;t++)void 0===e[t].color&&(e[t].color="none"),void 0===e[t].freq&&(e[t].freq=null),void 0===e[t].midi&&(e[t].midi=null),void 0===e[t].choke&&(e[t].choke=null);R=document.createElement("div"),R.style.width=g()+"px",R.style.position="relative",R.style.overflow="hidden",R.style.backgroundColor="#666",Tooltip.appendTooltippableChild(document.getElementById(P.widgetId),R);var n=document.createElement("div");R.appendChild(n),I=Elm.SimplePianoRoll.embed(n,{lanes:e,beats:P.beats,gridSize:P.gridSize/4,width:g(),height:m(),labelWidth:b(),scaleName:P.defaultScale?P.defaultScale:null,rootName:P.defaultRoot?P.defaultRoot:null,octave:P.defaultOctave?parseInt(P.defaultOctave):null,octaveCount:P.defaultOctaveCount?parseInt(P.defaultOctaveCount):null,showRootChooser:"yes"==P.showRootChooser,showScaleChooser:"yes"==P.showScaleChooser,availableScales:P.availableScales?P.availableScales.split(","):[],showTempoSlider:"no"!=P.showTempoSlider,showSettings:!0,tempo:parseFloat(P.tempo),highlightedLanes:P.highlightedLanes?P.highlightedLanes:[],options:{allowResize:void 0==P.allowResize||P.allowResize}}),d(),A=document.createElement("div"),A.className="widget-pianoroll__mouse-observer-holder",A.style.left=b()+"px",A.style.width=v()+"px",A.style.height=h()+"px",R.appendChild(A),(new SingleTouchObserver).init({node:A,onDown:function(e,t){I.ports.mouseDown.send([e,t])},onMove:function(e,t){I.ports.mouseMove.send([e,t])},onUp:function(e,t){I.ports.mouseUp.send([e,t])}}),L=document.createElement("div"),L.className="widget-pianoroll__playhead",L.style.bottom="0px",L.style.height=h()-2+"px",R.appendChild(L),C=document.createElement("div"),C.className="widget-pianoroll__playhead",C.style.bottom=f()+"px",C.style.height=E()-1+"px",R.appendChild(C),p(),window.addEventListener("resize",p)}function d(){I.ports.exportModel.subscribe(function(e){var t=!x||e.page!=x.page,n=!x||e.lanes.length!=x.lanes.length;x=e,S.trigger("modelChange",e),t&&S.trigger("pageChange"),n&&p()}),I.ports.previewNotes.subscribe(function(e){S.trigger("previewNotes",e,!0)}),I.ports.notesSelected.subscribe(function(e){S.trigger("previewNotes",e,!0)}),I.ports.notesDragged.subscribe(function(e){S.trigger("previewNotes",e,!0)}),I.ports.notesAdded.subscribe(function(e){S.trigger("previewNotes",e,!1)}),I.ports.tempoChanged.subscribe(function(e){S.trigger("tempoChanged",e)})}function u(){var e=x?x.page:-1,t=-1==e||0==e?0:4*e-.25,n=-1==e||e==P.beats/4-1?P.beats:4*(e+1)+.25;return[t/P.beats,n/P.beats]}function c(e){if(e>0){C.style.transform="translateX("+(e*v()+b())+"px)",C.style.opacity=1;var t=u(),n=pctInRange(t[0],t[1],e);fitsInRange(0,1,n)?(L.style.transform="translateX("+(n*v()+b())+"px)",L.style.opacity=1):L.style.opacity=0}else L.style.opacity=0,C.style.opacity=0}function p(){R.style.width=g()+"px",L.style.height=h()-1+"px",A.style.width=v()+"px",A.style.height=h()+"px",C.style.bottom=f()+"px",I.ports.setSize.send([g(),m()])}function f(){return h()+1}function m(){return h()+E()}function g(){var e=document.getElementById(P.widgetId);return parseInt(e.offsetWidth,10)}function v(){return g()-b()}function h(){return T()*y()}function y(){return x?x.lanes.length:P.lanes.length}function T(){var e=isMobile()?36:60,t=(25-e)/12,n=e-4*t,o=Math.round(t*y()+n);return _.clamp(o,25,e)}function w(){return P.beats>4}function E(){return w()?50:0}function b(){return P?"drums"!=P.material||isMobile()?62:124:62}var S=this;S.init=e,S.clear=t,S.setModel=n,S.getModel=r,S.record=s,S.setPlayhead=c,S.setOptions=i,S.updateTempo=o,S.getEditorTooltipWrapper=a;var I,P,x,L,C,R,A;return S};MicroEvent.mixin(PianoRollEditor);var PianoRollExport={createExportData:function(e,t,n){var o=e.events.map(function(t){return{midi:PianoRollExport.laneToMidi(e,t.lane),startInBeats:t.start,durationInBeats:t.duration}});return{tempo:t,tracks:[{instrument:n,clip:{lengthInBeats:e.beats,notes:o}}]}},laneToMidi:function(e,t){var n=e.lanes.length,o=e.lanes[n-1-t];return o.freq?Math.round(Tone.Frequency(o.freq).toMidi()):o.midi}},PianoRollPlayer=this.PianoRollPlayer=function(){function e(e){f=e}function t(e){g=e,p&&i()}function n(e){f&&(u(),g?(p.loopStart=beatsAsBarsBeatsSixteenths(g.start),p.loopEnd=beatsAsBarsBeatsSixteenths(g.end),p.loop=!0,p.start(e,p.loopStart)):p.start(e))}function o(e){p&&p.stop(e)}function i(){o(),Tone.Transport.position="0:0:0",n()}function r(e){m||(m=[]),m.push(e)}function a(e){var t=e.map(function(e){return e.lane}),n=_.uniq(t),o=n.map(function(e){var t=f.lanes.length-1-e;return{lane:f.lanes[t],length:"16n",time:"+0.1"}});c.trigger("playNotes",o)}function s(){if(!f||!p)return 0;var e=getTotalBeats(Tone.Time(p.loopStart).toBarsBeatsSixteenths()),t=getTotalBeats(Tone.Time(p.loopEnd).toBarsBeatsSixteenths());return(e+p.progress*(t-e))/f.beats}function l(e){m=m.filter(function(t){return(t.start+t.duration)%f.beats>e}),0===e&&(m=m.filter(function(e){return e.start+e.duration>f.beats}))}function d(e){return f.events.filter(function(t){return t.start==e})}function u(){var e=1/f.gridSize,t=4*f.gridSize+"n",n=f.gridSize*f.beats,o=f.lanes.length;p&&p.dispose(),p=new Tone.Sequence(function(n,i){if(f){var r=i*e;m&&l(r);var a=d(r).filter(function(e){return!(m&&-1!=m.findIndex(function(t){return t.lane==e.lane}))}),s=a.map(function(i){var r=i.duration/e,a=o-i.lane-1,s=t+" * "+r;return{lane:f.lanes[a],length:s,time:n}});c.trigger("playNotes",s)}},_.range(0,n),t)}var c=this;c.setModel=e,c.setLoop=t,c.start=n,c.stop=o,c.record=r,c.progress=s,c.previewNotes=a;var p,f,m,g;return c};MicroEvent.mixin(PianoRollPlayer);var SimplePianoRoll=this.SimplePianoRoll=function(){function e(e){if(!BrowserCompatibility.isBrowserCompatible())return void BrowserCompatibility.appendCompatibilityWarning(document.getElementById(e.widgetId),e.lang["@incompatiblebrowser"]);isMobile()&&document.getElementById(e.widgetId).classList.add("widget-is-mobile"),L=e,x=new Loader,x.init(L),L.recorder&&L.recorder.connect(I),
L.exporter&&"yes"!=L.disableExport&&L.exporter.registerWidget(P),t(),f(),N=_.debounce(a,500)}function t(){M=new PianoRollPlayer,"tonal"==L.material?(B=new Piano,B.init(L.instrument).then(n)):"drums"==L.material&&(B=new Drumkit,B.init(L.instrument.samples).then(n))}function n(){x.onAudioLoaded(),SUPERVISOR.makeGestureOnElementResumeAudioContext(document.getElementById(L.widgetId)),g(),O=new PianoRollEditor,O.init(L),O.bind("modelChange",function(e){M.setModel(e),f(),c(),p(),N()}),O.bind("pageChange",function(){m()}),O.bind("previewNotes",function(e,t){!t&&C.isPlaying()||M.previewNotes(e)}),O.bind("tempoChanged",function(e){C.setTempo(e),c(),N()}),M.bind("playNotes",function(e){"tonal"==L.material?e.forEach(function(e){B.playNoteAtFrequency(e.lane.freq,e.time,e.length)}):"drums"==L.material&&B.playNotes(e)}),r()&&s(),L.defaultState&&d();var e=getSavedModel(L.widgetId);e&&(e.tempo&&C.setTempo(e.tempo),O.setModel(e)),L.tip&&o(L.tip),d3.timer(l)}function o(e){function t(e){var t=L.tips[e];return t.name=e,t["@close"]=L.lang["@close"],t}switch(e){case"playstop":Tooltip.inject(C.playButton().parentElement,t(e),"100%","50%","left");break;case"record":Tooltip.inject(C.recordButton().parentElement,t(e));break;case"createdeletenotes":Tooltip.inject(O.getEditorTooltipWrapper(),t(e),"70%","60%");break;case"dragnotes":Tooltip.inject(O.getEditorTooltipWrapper(),t(e),"50%","55%");break;case"resizenotes":case"selectnotes":Tooltip.inject(O.getEditorTooltipWrapper(),t(e),"50%","65%");break;case"tempo":Tooltip.inject(O.getEditorTooltipWrapper(),t(e),"15%","50%");break;case"overview":Tooltip.inject(O.getEditorTooltipWrapper(),t(e),"30%","80%","right");break;case"export":i()&&Tooltip.inject(k.parentElement,t(e),"100%","50%","right");break;case"exportnotsupportedchromeios":Tooltip.inject(k.parentElement,t(e),"100%","50%","right")}}function i(){return!isChromeOnIOS()}function r(){return 4===L.beats&&"drums"===L.material&&void 0==L.recorder}function a(){var e=O.getModel();e&&(e.tempo=C.getTempo(),trySaveState(e,L.widgetId,PIANOROLL_VERSION))}function s(){var e=document.createElement("div");e.className="widget-drumsequencer__column-labels";for(var t=0;t<16;t++){var n=document.createElement("div");n.className="widget-drumsequencer__column-label",t%4==0&&n.classList.add("widget-drumsequencer__column-label--beat"),n.innerHTML=t+1,e.appendChild(n)}document.getElementById(L.widgetId).appendChild(e)}function l(){var e=C.isPlaying()?M.progress():0;O.setPlayhead(e)}function d(){if(C.setTempo(T()),L.defaultState)O.setModel(JSON.parse(L.defaultState));else if(L.defaultRoot||L.defaultScale){var e=O.getModel();e.scaleName=L.defaultScale,e.rootName=L.defaultRoot,e.tempo=T(),O.setModel(e)}}function u(){C.setTempo(T()),O.setModel(JSON.parse(L.targetState))}function c(){if(R){var e=b()?"widget-button--hidden":"";R.className="btn btn--link btn--cropped "+e}}function p(){if(A){var e=S()?"":"widget-button--hidden";A.className="btn btn--link btn--cropped "+e}}function f(){var e=document.getElementById(L.widgetId+"correct"),t=document.getElementById(L.widgetId+"generic");if(e&&t){var n=w();e.className=n?"widget__dynamic-text":"widget__dynamic-text widget__dynamic-text--hidden",t.className=n?"widget__dynamic-text widget__dynamic-text--hidden":"widget__dynamic-text"}}function m(){if("takeover"==L.onPlay){B.stopAll();var e=O?O.getModel():void 0;e&&-1!=e.page?M.setLoop({start:4*e.page,end:4*e.page+4}):M.setLoop({start:0,end:L.beats})}}function g(){var e=document.createElement("div");e.className="widget__menu",document.getElementById(L.widgetId).appendChild(e),C=new Transport,C.init({node:e,onStartPlayback:function(){M.start()},onStartQuantizedPlayback:function(){M.start("@1m")},onStopPlayback:function(){M.stop(),B.stopAll()},onPlay:L.onPlay,tempo:T(),onTempoChanged:function(e){O.updateTempo(e),c(),N()},showRecordButton:L.recorder,widgetId:L.widgetId}),(L.defaultState||L.tempo)&&(R=document.createElement("button"),R.innerHTML=L.lang["@reset"],R.className="widget-button widget-button--hidden",R.onclick=d,e.appendChild(R)),A=document.createElement("button"),A.innerHTML=L.lang["@clear"],A.className="widget-button",A.style.marginLeft="auto",A.onclick=function(){O.clear()},e.appendChild(A),k=document.createElement("button"),k.innerHTML=L.lang["@exporttolive"],k.className="btn btn--link btn--cropped",k.onclick=function(){function e(e){k.style.pointerEvents="initial",k.innerHTML=L.lang["@exporttolive"],e&&console.log(e)}if(!i())return k.style.pointerEvents="none",k.style.opacity=.25,void o("exportnotsupportedchromeios");k.style.pointerEvents="none",k.innerHTML=L.lang["@exporting"]+"...",P.trigger("export",P,e)},"yes"!=L.disableExport&&(Tooltip.appendTooltippableChild(e,k),LiveSetExport.checkExportServiceAvailablility(function(e){k.style.opacity=e?1:.25,k.style.pointerEvents=e?"auto":"none"}))}function v(){return L}function h(){return PianoRollExport.createExportData(O.getModel(),C.getTempo(),L.instrument.livePreset)}function y(){u()}function T(){return L.tempo?parseInt(L.tempo):85}function w(){var e=O?O.getModel():void 0;return!(!L.targetState||!e)&&("tonal"==L.material?PianoRollAssessment.modelsMatch(JSON.parse(L.targetState),O.getModel(),e.lanes.length):"drums"==L.material?PianoRollAssessment.populatedLanesMatch(JSON.parse(L.targetState),O.getModel(),e.lanes.length):void 0)}function E(e){if(!e)return!0;var t=!L.defaultRoot||L.defaultRoot===e.rootName,n=!L.defaultScale||L.defaultScale===e.scaleName;return t&&n}function b(){var e=O?O.getModel():void 0;return L.defaultState?T()===C.getTempo()&&E(e)&&PianoRollAssessment.modelsMatch(JSON.parse(L.defaultState),O.getModel(),L.lanes.length):T()===C.getTempo()&&E(e)}function S(){var e=O?O.getModel():void 0;return!!e&&e.events.length>0}function I(e){var t=L.lanes.map(function(e){return e.midi}),n=L.lanes.length-t.indexOf(e.midi)-1,o=M.progress(),i=o*L.beats;C.isRecording()&&C.isPlaying()&&(O.record({lane:n,start:i,duration:.25}),M.record({lane:n,start:i,duration:.25}))}var P=this;P.init=e,P.showTargetState=y,P.getExportInfo=h,P.getConfig=v;var x,L,C,R,A,k,M,O,B,N;return P};MicroEvent.mixin(SimplePianoRoll);var SimpleSession=this.SimpleSession=function(){function e(){d.onAudioLoaded(),SUPERVISOR.makeGestureOnElementResumeAudioContext(u),c=document.createElement("div"),Tooltip.appendTooltippableChild(u,c);for(var e=0;e<s.preset.tracks.length;e++){var n=s.preset.tracks[e];n.name=n["@name"]}l=Elm.SimpleSession.embed(c,s.preset),o(),s.tip&&t(s.tip)}function t(e){switch(e){case"devicemute":if(!isMobile())return;Tooltip.inject(c,function(e){var t=s.tips[e];return t.name=e,t["@close"]=s.lang["@close"],t}(e),"65%","60%","right")}}function n(e,t){s.preset.tracks[t].clips.forEach(function(t){t.name!=e.name&&(Tone.Transport.clear(m[t.name]),Tone.Transport.scheduleOnce(function(e){try{p.stop(t.name,e)}catch(e){}},"@1m"))})}function o(){Tone.Transport.scheduleRepeat(function(e){l.ports.onTick.send(""+e)},"1m"),l.ports.playSound.subscribe(function(e){var t=e[0],o=e[1];"stopped"==Tone.Transport.state&&(Tone.Transport.position="0:0:0",Tone.Transport.start(ToneTransportStartDelay())),"stopped"==f&&(f="playing"),n(t,o),m[t.name]=Tone.Transport.scheduleRepeat(function(e){try{p.stop(t.name,e)}catch(e){}p.start(t.name,e,0,t.length),SUPERVISOR.registerPlayingWidget(s.widgetId)},t.length,"@1m")}),l.ports.unqueueSound.subscribe(function(e){Tone.Transport.clear(m[e.name])}),l.ports.stopSound.subscribe(function(e){Tone.Transport.clear(m[e.name]),Tone.Transport.scheduleOnce(function(t){try{p.stop(e.name,t)}catch(e){}},"@1m")}),l.ports.allSoundsStopped.subscribe(function(e){SUPERVISOR.isOnlyWidgetPlaying(s.widgetId)&&(Tone.Transport.position="0:0:0",Tone.Transport.stop()),f="stopped",SUPERVISOR.unregisterPlayingWidget(s.widgetId)})}function i(e){var t={},n=getAudioExtension();return e.tracks.forEach(function(e,o){e.clips.forEach(function(e,o){var i=e.name;t[i]=pathToWidgetSounds()+e.path+n})}),t}function r(t){if(!BrowserCompatibility.isBrowserCompatible())return void BrowserCompatibility.appendCompatibilityWarning(document.getElementById(t.widgetId),t.lang["@incompatiblebrowser"]);s=t,u=document.getElementById(s.widgetId),d=new Loader,d.init(s),Tone.Transport.bpm.value=s.preset.tempo,f="stopped",p=new Tone.MultiPlayer(i(s.preset),function(){e()}).toMaster(),m={}}var a=this;a.init=r;var s,l,d,u,c,p,f,m;return a},SongFormExplorer=this.SongFormExplorer=function(){function e(){var e=document.createElement("div");s.appendChild(e);for(var i=0;i<l.preset.sections.length-1;i++){var r=l.preset.sections[i],d=l.preset.sections[i+1];r.end=d.start}l.preset.sections[l.preset.sections.length-1].end=l.preset.songLength;for(var i=0;i<l.preset.sections.length;i++){var r=l.preset.sections[i];r.description=r["@description"],r.name=r["@name"],r.label=r["@label"]}for(var i=0;i<l.preset.sections.length;i++){var r=l.preset.sections[i];r["@label"]||(r.label=r.name)}a=Elm.SongFormExplorer.embed(e,l.preset),n(),l.player.setPlayheadChangedCallback(o),l.tip&&t(l.tip)}function t(e){switch(e){case"songformsections":s.style.position="relative",Tooltip.inject(s,function(e){var t=l.tips[e];return t.name=e,t["@close"]=l.lang["@close"],t}(e),"45px","65%")}}function n(){a.ports.jumpToSection.subscribe(function(e){l.player.setPlayheadToTime(e.start)})}function o(e){a.ports.updatePlayhead.send(e)}function i(t){l=t,s=document.getElementById(l.widgetId),e()}var r=this;r.init=i;var a,s,l;return r};YOUTUBEWIDGETS=[],YOUTUBE_API_READY=!1;var YouTube=this.YouTube=function(){function e(){s()}function t(e){l(),Tone.Transport.on("takeover",n),document.getElementById(p.widgetId).classList.add("is-ready")}function n(e){"takeover"==p.onPlay&&e!=p.widgetId&&v.getPlayerState()===YT.PlayerState.PLAYING&&(v.pauseVideo(),T=!0)}function o(){v&&v.getPlayerState()==YT.PlayerState.PLAYING&&y&&y(v.getCurrentTime())}function i(e){y=e}function r(e){void 0!==v&&void 0!==v.getPlayerState&&(v.getPlayerState()!=YT.PlayerState.PLAYING&&y&&y(e),v.seekTo(e),T&&v.playVideo(),Tone.Transport.emit("takeover",p.widgetId))}function a(e){if(e.data==YT.PlayerState.PLAYING||e.data==YT.PlayerState.BUFFERING){var t=document.getElementById(p.widgetId);t.classList.remove("is-ready"),t.classList.add("is-playing")}e.data==YT.PlayerState.PLAYING?("takeover"==p.onPlay&&Tone.Transport.emit("takeover",p.widgetId),h?h.restart(o):h=d3.timer(o),SUPERVISOR.registerPlayingWidget(p.widgetId),T=!1):(SUPERVISOR.unregisterPlayingWidget(p.widgetId),h&&h.stop(o))}function s(){v=new YT.Player(p.widgetId+"video",{videoId:p.videoId,playerVars:{controls:2,disablekb:1,showinfo:0,color:"white",modestbranding:1,fs:0,playsinline:1,start:p.start?parseInt(p.start):0,end:p.end?parseInt(p.end):void 0,loop:p.loop&&"yes"===p.loop?1:0},events:{onReady:t,onStateChange:a}})}function l(){f.hide(),document.getElementById(p.widgetId+"video").style.display="block"}function d(){f=new Loader,f.init(p),YOUTUBE_API_READY?s():YOUTUBEWIDGETS.push(c)}function u(e){p=e,m=document.getElementById(p.widgetId),g=document.createElement("div"),g.className="widget-video__holder",g.id=p.widgetId+"video",g.style.display="none",m.appendChild(g),p.width&&(g.style.width=p.width+"px"),T=!1,d()}var c=this;c.init=u,c.onYouTubeIframeAPIReady=e,c.setPlayheadChangedCallback=i,c.setPlayheadToTime=r;var p,f,m,g,v,h,y,T;return c};